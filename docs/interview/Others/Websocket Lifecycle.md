# websocket的生命周期

WebSocket 是一种在客户端和服务器之间实现全双工通信的协议。WebSocket 的生命周期包括连接建立、数据传输和连接关闭等阶段。

### 1. 连接建立阶段：

- **握手阶段：** WebSocket 连接的建立始于客户端发起的握手请求。客户端发送一个 HTTP 请求，包含一个特殊的头信息 `Upgrade: websocket`。服务器在接收到这个请求后，如果支持 WebSocket，会返回一个状态码为 `101 Switching Protocols` 的响应，表示协议切换成功。

- **连接打开：** 握手成功后，连接就打开了。此时，可以通过 WebSocket 实例发送和接收消息。

### 2. 数据传输阶段：

- **消息传输：** 在连接建立后，客户端和服务器可以通过 WebSocket 连接发送和接收消息。消息可以是文本、二进制数据等。通过发送消息，双方可以进行实时通信。

### 3. 连接关闭阶段：

- **主动关闭连接：** 任何一方可以通过发送一个关闭帧来主动关闭连接。帧中包含关闭的状态码和可选的关闭原因。接收方在收到关闭帧后，也会发送一个关闭帧进行确认。

- **被动关闭连接：** 如果连接的任何一方检测到某种错误或需要关闭连接，它可以直接关闭连接。另一方会收到关闭帧，然后执行相应的关闭操作。

- **连接关闭：** 一旦连接关闭，WebSocket 实例就不再可用。在关闭连接之后，不再能够发送或接收消息。

### WebSocket 的生命周期示意图：

```
   +------------------+
   |   握手阶段        |
   +------------------+
          |
          v
   +------------------+
   | 连接打开         |
   +------------------+
          |
          v
   +------------------+
   | 数据传输阶段      |
   +------------------+
          |
          v
   +------------------+
   | 连接关闭阶段      |
   +------------------+
```

需要注意的是，WebSocket 是一种长连接，通常情况下会保持持久性的连接。在生命周期的任意阶段，都有可能发生连接断开或出现异常的情况，因此在实际使用中，需要进行适当的错误处理和连接状态的监控。