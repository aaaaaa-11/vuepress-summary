# 浏览器输入URL

1. 域名解析

    把URL包含的一些信息解析出来

    浏览器接收到URL后，这一个URL的结构一般是：

    Protocal://Host:Port/Path?Query#Fragment

    - Protocal：协议
    - Host：主机域名/IP
    - Port：端口号
    - Path：目录路径，可能是服务器上某个目录/文件地址
    - Query：查询参数
    - Fragment：前端路径、锚点等

2. 发起请求

    如果是一个HTTP请求，需要建立一个网络请求线程

    - DNS解析

      客户端向服务器端发请求，需要根据IP地址进行通信，所以需要先找到目标服务器端IP

      先从浏览器的DNS的缓存中查看是否有目标服务器的IP地址，如果没有，就从系统DNS缓存中找，如果还没有，就从hosts文件里面找，找不到就报错

    - TCP连接

      客户端和服务器端建立TCP连接，需要进行“三次握手”：

      1. 客户端向服务器端发送一个报文，包含一些信息，可以看作一个“暗号” —— 客户端请求连接待确认
      2. 服务器端接收到这个报文，知道有客户端希望建立连接并等待应答，它拿到“暗号”，然后自己也创建一个新“暗号”，然后把这些信息返给客户端 —— 服务器端请求连接待确认
      3. 客户端拿到报文，发现里面有自己发给服务端的“暗号”，确认是对应的服务器，然后也拿到服务器的“暗号”，就再把服务器的这个暗号再发给服务器端
      4. 服务器端拿到客户端的报文，发现有自己发送过去的“暗号”，所以现在双方确认过彼此，就可以建立连接了

      客户端和服务器端断开连接的时候，需要进行“四次握手”：

      1. 客户端向服务器端发送断开连接的请求
      2. 服务器端收到后给到客户端应答，让客户端等一下，因为这个时候可能还有没完成的资源下载之类的
      3. 服务器这边资源下载完成，没啥事了，就再给客户端一个应答，告诉客户端可以断开连接了，如果客户端没有确认，会一直发送
      4. 客户端收到后，需要再次发送确认断开的请求，如果服务器端没有收到，会在一段时间后断开连接

3. 请求

    一般会用到缓存，缓存有两种：强缓存和协商缓存

    - 强缓存：先看浏览器本地缓存是否过期，未过期则直接用200，不需要发请求了；过期了则向服务器端请求资源

    - 协商缓存：

        1. 浏览器是否有缓存

            1.1 没有 -> 请求服务器资源

            1.2 有 -> 查看缓存是否过期

            - 1.2.1 本地缓存没有过期，则直接用

            - 1.2.2 已经过期，则向服务器询问资源是否有修改

            - 1.2.2.1 如果没有修改，则还是用缓存304

            - 1.2.2.2 有修改，则返回新的资源，并存到缓存中

        2. 拿到资源后，加载页面

        一般强缓存优于协商缓存，强缓存生效则用强缓存，否则用协商缓存，如果都不生效，则向服务器端请求资源


4. 网页加载

    整体流程：HTML + CSS -> DOM + CSSOM -> 渲染树 -> 开始渲染 -> “盒模型” -> 开始绘制 -> 页面

    详细：

    拿到HTML + CSS + JS等文件后，需要加载页面

    HTML -> 词法分析、语法分析。。。 -> DOM树

    CSS -> ... -> CSSOM树

    CSSOM + DOM -> 渲染树：遍历DOM树节点，给每个子节点找到对应的CSS的规则

    CSSOM（层叠样式表对象模型），DOM（文档对象模型）

    拿到渲染树后，开始渲染，需要计算DOM节点的大小和位置，这时候计算出来一个“盒模型”

    然后开始绘制，就是把节点绘制成对应的像素